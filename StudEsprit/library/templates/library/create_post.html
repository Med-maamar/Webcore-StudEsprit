{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
  <div class="max-w-4xl mx-auto py-8">
    <!-- Header -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8 mb-8">
      <div class="flex items-center gap-3 mb-2">
        <a href="{% url 'library:community' %}" class="p-2 text-gray-600 hover:text-purple-600 hover:bg-purple-50 rounded-lg transition-all duration-200">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </a>
        <div class="p-3 bg-gradient-to-r from-purple-500 to-purple-600 rounded-xl">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
        </div>
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-purple-800 bg-clip-text text-transparent">Cr√©er un Post</h1>
          <p class="text-gray-600 mt-1">Partagez votre exp√©rience avec la communaut√©</p>
        </div>
      </div>
    </div>

    <!-- Create Post Form -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-8">
      <!-- NOTE: form enctype added to allow attachments; backend must handle request.FILES to persist files -->
      <form method="POST" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
        
        <!-- Title -->
        <div>
          <label for="title" class="block text-sm font-semibold text-gray-900 mb-2">
            Titre du Post *
          </label>
          <input type="text" id="title" name="title" required
                 class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                 placeholder="Donnez un titre accrocheur √† votre post...">
        </div>

        <!-- Category -->
        <div>
          <label for="category" class="block text-sm font-semibold text-gray-900 mb-2">
            Cat√©gorie *
          </label>
          <select id="category" name="category" required
                  class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <option value="">S√©lectionnez une cat√©gorie</option>
            <option value="question">‚ùì Question</option>
            <option value="help">üÜò Demande d'aide</option>
            <option value="experience">üí° Exp√©rience</option>
            <option value="tip">üí° Conseil</option>
            <option value="discussion">üí¨ Discussion</option>
            <option value="general">üìù G√©n√©ral</option>
          </select>
        </div>

        <!-- Content -->
        <div>
          <label for="content" class="block text-sm font-semibold text-gray-900 mb-2">
            Contenu *
          </label>
          <textarea id="content" name="content" rows="12" required
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                    placeholder="Partagez votre exp√©rience, posez votre question, ou donnez des conseils √† vos camarades..."></textarea>
          <p class="text-sm text-gray-500 mt-2">
            üí° <strong>Conseils pour un bon post :</strong>
            <br>‚Ä¢ Soyez clair et pr√©cis dans votre message
            <br>‚Ä¢ Utilisez des exemples concrets si possible
            <br>‚Ä¢ Respectez les autres membres de la communaut√©
            <br>‚Ä¢ Utilisez des tags pour faciliter la recherche
          </p>
        </div>

        <!-- Tags -->
        <div>
          <label for="tags" class="block text-sm font-semibold text-gray-900 mb-2">
            Tags (optionnel)
          </label>
          <input type="text" id="tags" name="tags"
                 class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                 placeholder="Ex: django, python, projet, aide, √©tude (s√©par√©s par des virgules)">
          <p class="text-sm text-gray-500 mt-2">
            S√©parez les tags par des virgules. Cela aidera les autres √† trouver votre post.
          </p>
        </div>

        <!-- Attachments -->
        <div>
          <label for="attachments" class="block text-sm font-semibold text-gray-900 mb-2">
            Fichiers (optionnel)
          </label>
          <input id="attachments" name="attachments" type="file" multiple
                 accept=".pdf,.doc,.docx,.ppt,.pptx,.txt,.md,.jpg,.jpeg,.png"
                 class="w-full text-sm text-gray-600">
          <p class="text-sm text-gray-500 mt-2">Vous pouvez joindre des documents pour aider les autres (PDF, DOCX, images...). Maximum recommand√©: 10 Mo par fichier.</p>
          <div id="attachmentsPreview" class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-3"></div>
        </div>

        <!-- Offer Services -->
        <div class="border-t pt-4">
          <h4 class="text-sm font-semibold text-gray-900 mb-2">Offrez votre aide</h4>
          <label class="inline-flex items-center gap-2">
            <input type="checkbox" id="offerService" name="offer_service" class="rounded" />
            <span class="text-sm text-gray-700">Je propose mes services gratuitement pour aider d'autres √©tudiants</span>
          </label>
          <div id="serviceDetails" class="mt-3 hidden">
            <label for="service_description" class="block text-sm font-semibold text-gray-900 mb-2">Description du service (optionnel)</label>
            <textarea id="service_description" name="service_description" rows="4"
                      class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"
                      placeholder="D√©crivez vos comp√©tences, disponibilit√©, et la fa√ßon dont vous pouvez aider (ex: tutorat, relecture, coaching de projet)..."></textarea>

            <label for="contact_pref" class="block text-sm font-semibold text-gray-900 mb-2 mt-3">Pr√©f√©rence de contact</label>
            <select id="contact_pref" name="contact_pref" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
              <option value="in_app">Message dans l'application</option>
              <option value="email">Email</option>
              <option value="other">Autre (pr√©cisez dans la description)</option>
            </select>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="flex items-center gap-4 pt-6 border-t border-gray-200">
          <button type="submit" 
                  class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-8 py-4 rounded-xl font-semibold hover:from-purple-600 hover:to-purple-700 transition-all duration-200 flex items-center gap-3 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            Publier le Post
          </button>
          <a href="{% url 'library:community' %}" 
             class="bg-gray-100 text-gray-700 px-6 py-4 rounded-xl font-semibold hover:bg-gray-200 transition-all duration-200">
            Annuler
          </a>
        </div>
      </form>
    </div>

    <!-- Guidelines -->
    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-2xl border border-blue-200 p-6 mt-8">
      <h3 class="text-lg font-semibold text-blue-900 mb-3">üìã R√®gles de la Communaut√©</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
        <div>
          <h4 class="font-semibold mb-2">‚úÖ √Ä faire :</h4>
          <ul class="space-y-1">
            <li>‚Ä¢ Respectez les autres membres</li>
            <li>‚Ä¢ Partagez des exp√©riences constructives</li>
            <li>‚Ä¢ Aidez vos camarades √©tudiants</li>
            <li>‚Ä¢ Utilisez un langage appropri√©</li>
          </ul>
        </div>
        <div>
          <h4 class="font-semibold mb-2">‚ùå √Ä √©viter :</h4>
          <ul class="space-y-1">
            <li>‚Ä¢ Spam ou contenu inappropri√©</li>
            <li>‚Ä¢ Langage offensant ou discriminatoire</li>
            <li>‚Ä¢ Partage d'informations personnelles</li>
            <li>‚Ä¢ Contenu non li√© aux √©tudes</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Auto-resize textarea
const textarea = document.getElementById('content');
textarea.addEventListener('input', function() {
  this.style.height = 'auto';
  this.style.height = this.scrollHeight + 'px';
});

// Character counter for content
const contentTextarea = document.getElementById('content');
const maxLength = 2000;

contentTextarea.addEventListener('input', function() {
  const currentLength = this.value.length;
  const remaining = maxLength - currentLength;
  
  // Create or update counter
  let counter = document.getElementById('char-counter');
  if (!counter) {
    counter = document.createElement('div');
    counter.id = 'char-counter';
    counter.className = 'text-sm text-gray-500 mt-2';
    this.parentNode.appendChild(counter);
  }
  
  if (remaining < 100) {
    counter.className = 'text-sm text-red-500 mt-2';
  } else if (remaining < 200) {
    counter.className = 'text-sm text-yellow-500 mt-2';
  } else {
    counter.className = 'text-sm text-gray-500 mt-2';
  }
  
  counter.textContent = `${currentLength}/${maxLength} caract√®res`;
  
  if (currentLength > maxLength) {
    this.value = this.value.substring(0, maxLength);
    counter.textContent = `${maxLength}/${maxLength} caract√®res (limite atteinte)`;
  }
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
  const title = document.getElementById('title').value.trim();
  const content = document.getElementById('content').value.trim();
  const category = document.getElementById('category').value;
  
  if (!title || !content || !category) {
    e.preventDefault();
    alert('Veuillez remplir tous les champs obligatoires.');
    return false;
  }
  
  if (content.length < 10) {
    e.preventDefault();
    alert('Le contenu doit contenir au moins 10 caract√®res.');
    return false;
  }
});

// Attachments preview and validation
const attachmentsInput = document.getElementById('attachments');
const attachmentsPreview = document.getElementById('attachmentsPreview');
if (attachmentsInput) {
  attachmentsInput.addEventListener('change', function() {
    attachmentsPreview.innerHTML = '';
    const files = Array.from(this.files || []);
    const allowed = ['application/pdf','application/msword','application/vnd.openxmlformats-officedocument.wordprocessingml.document','text/plain','image/jpeg','image/png','application/vnd.ms-powerpoint','application/vnd.openxmlformats-officedocument.presentationml.presentation','text/markdown'];
    files.forEach(file => {
      const el = document.createElement('div');
      el.className = 'p-3 bg-gray-50 rounded-lg text-sm text-gray-700 border border-gray-100';
      const info = document.createElement('div');
      info.innerHTML = `<strong>${file.name}</strong><div class="text-xs text-gray-500">${(file.size/1024/1024).toFixed(2)} MB</div>`;
      el.appendChild(info);
      // Basic type check
      if (!allowed.includes(file.type) && !file.name.match(/\.(pdf|docx?|pptx?|txt|md|jpe?g|png)$/i)) {
        const warn = document.createElement('div');
        warn.className = 'text-xs text-red-500 mt-1';
        warn.textContent = 'Type de fichier non support√©';
        el.appendChild(warn);
      }
      attachmentsPreview.appendChild(el);
    });
  });
}

// Offer service toggle
const offerCheckbox = document.getElementById('offerService');
const serviceDetails = document.getElementById('serviceDetails');
if (offerCheckbox) {
  offerCheckbox.addEventListener('change', function() {
    if (this.checked) serviceDetails.classList.remove('hidden'); else serviceDetails.classList.add('hidden');
  });
}
</script>
{% endblock %}

