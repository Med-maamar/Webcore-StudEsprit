{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">
  <div class="h-screen flex flex-col">
    <!-- Enhanced Header -->
    <div class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <a href="{% url 'library:home' %}" class="p-2 text-gray-600 hover:text-esprit-red hover:bg-red-50 rounded-lg transition-all duration-200">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
          </a>
          <div class="flex items-center gap-3">
            <div class="p-2 bg-gradient-to-r from-esprit-red to-red-600 rounded-lg">
              <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
            </div>
            <div>
              <h1 class="text-xl font-bold text-esprit-dark">{{ document.title }}</h1>
              <div class="flex items-center gap-4 text-sm text-gray-600">
                <span>{{ document.filename }}</span>
                <span>{{ document.file_size|filesizeformat }}</span>
                {% if document.is_processed %}
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-green-100 to-green-200 text-green-800 border border-green-300">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Prêt pour l'IA
                  </span>
                {% else %}
                  <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-800 border border-yellow-300">
                    <svg class="w-3 h-3 mr-1 animate-spin" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Traitement en cours
                  </span>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="showDocumentTools()" class="p-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200" title="Outils IA">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </button>
          <button onclick="toggleFullscreen()" class="p-2 bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-lg transition-all duration-200" title="Plein écran">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">
      <!-- Chat Interface -->
      <div class="flex-1 flex flex-col bg-white">
        <!-- Chat Header -->
        <div class="bg-gradient-to-r from-esprit-red to-red-600 text-white px-6 py-4">
          <div class="flex items-center gap-3">
            <div class="p-2 bg-white bg-opacity-20 rounded-lg">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
            </div>
            <div>
              <h2 class="text-lg font-semibold">Assistant IA</h2>
              <p class="text-sm opacity-90">Posez des questions sur ce document</p>
            </div>
          </div>
        </div>

        <!-- Chat Messages -->
        <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
          {% if document.is_processed %}
            <!-- Welcome Message -->
            <div class="flex items-start gap-3">
              <div class="p-2 bg-gradient-to-r from-esprit-red to-red-600 rounded-lg">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
              </div>
              <div class="bg-gray-100 rounded-2xl rounded-tl-lg p-4 max-w-2xl">
                <p class="text-gray-800">Bonjour ! Je suis votre assistant IA pour ce document. Posez-moi des questions sur le contenu et je vous aiderai à trouver les informations pertinentes.</p>
              </div>
            </div>

            <!-- Chat History -->
            {% for message in chat_session.messages %}
              <div class="flex items-start gap-3 {% if message.type == 'user' %}justify-end{% endif %}">
                {% if message.type == 'assistant' %}
                  <div class="p-2 bg-gradient-to-r from-esprit-red to-red-600 rounded-lg">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                  </div>
                {% endif %}
                <div class="{% if message.type == 'user' %}bg-gradient-to-r from-esprit-red to-red-600 text-white rounded-2xl rounded-tr-lg{% else %}bg-gray-100 rounded-2xl rounded-tl-lg{% endif %} p-4 max-w-2xl">
                  <p class="{% if message.type == 'user' %}text-white{% else %}text-gray-800{% endif %}">{{ message.content }}</p>
                </div>
                {% if message.type == 'user' %}
                  <div class="p-2 bg-gray-200 rounded-lg">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-12">
              <div class="p-4 bg-yellow-100 rounded-full w-16 h-16 mx-auto mb-4">
                <svg class="w-8 h-8 text-yellow-600 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
              <h3 class="text-lg font-semibold text-gray-900 mb-2">Traitement en cours</h3>
              <p class="text-gray-600">Votre document est en cours de traitement. L'assistant IA sera disponible dans quelques instants.</p>
            </div>
          {% endif %}
        </div>

        <!-- Chat Input -->
        {% if document.is_processed %}
          <div class="border-t border-gray-200 p-6">
            <form id="chatForm" class="flex gap-3">
              <div class="flex-1 relative">
                <input type="text" id="messageInput" placeholder="Posez votre question..." class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-esprit-red focus:border-transparent pr-12">
                <button type="button" onclick="clearInput()" class="absolute right-3 top-3 text-gray-400 hover:text-gray-600">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                  </svg>
                </button>
              </div>
              <button type="submit" class="bg-gradient-to-r from-esprit-red to-red-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-red-600 hover:to-red-700 transition-all duration-200 flex items-center gap-2 shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                Envoyer
              </button>
            </form>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Document Tools Modal -->
<div id="documentToolsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-xl font-bold text-gray-900">Outils IA</h3>
        <button onclick="closeDocumentTools()" class="text-gray-400 hover:text-gray-600">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      <div class="space-y-4">
        <div class="grid grid-cols-1 gap-3">
          <div class="flex gap-2">
            <select id="summaryLength" class="flex-1 px-3 py-2 border border-gray-200 rounded text-sm" title="Longueur du résumé">
              <option value="short">Court (1-2 phrases)</option>
              <option value="medium" selected>Moyen (3-5 phrases)</option>
              <option value="long">Long (6+ phrases)</option>
            </select>
            <label class="inline-flex items-center gap-2 text-sm text-gray-600">
              <input type="checkbox" id="autoRefineSummary" checked class="rounded" /> Auto-affiner
            </label>
          </div>
          <button onclick="generateSummary(event)" class="w-full p-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 transition-all duration-200 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Générer un résumé
        </button>
        
        <div class="grid grid-cols-1 gap-3">
          <div class="flex gap-2 items-center">
            <label class="text-sm text-gray-600">Questions</label>
            <input id="qaCount" type="number" min="1" max="20" value="5" class="w-20 px-2 py-1 border border-gray-200 rounded text-sm" />
            <span class="text-sm text-gray-400">(choisissez le nombre de Q&A à générer)</span>
          </div>
          <button onclick="generateQA(event)" class="w-full p-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold hover:from-green-600 hover:to-green-700 transition-all duration-200 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Générer Q&A
        </button>
        
  <button onclick="analyzeDocument(event)" class="w-full p-4 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-semibold hover:from-purple-600 hover:to-purple-700 transition-all duration-200 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
          Analyser le document
        </button>
        
  <button onclick="exportDocument()" class="w-full p-4 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-xl font-semibold hover:from-gray-600 hover:to-gray-700 transition-all duration-200 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Exporter
        </button>
        
        <button onclick="showStudyPath()" class="w-full p-4 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-xl font-semibold hover:from-indigo-600 hover:to-indigo-700 transition-all duration-200 flex items-center gap-3">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          Mon parcours d'étude
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Result Modal (used for summaries & QA) -->
<div id="resultModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-start justify-center min-h-screen p-6">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 id="resultModalTitle" class="text-xl font-bold text-gray-900">Résultat</h3>
          <div id="resultMeta" class="text-sm text-gray-600">&nbsp;</div>
        </div>
        <div class="flex items-center gap-2">
          <label for="refineTone" class="text-sm text-gray-600 mr-2">Ton</label>
          <select id="refineTone" class="px-2 py-1 border border-gray-200 rounded text-sm">
            <option value="professional">Professionnel</option>
            <option value="concise">Concise</option>
            <option value="detailed">Développé</option>
            <option value="friendly">Amical</option>
          </select>
          <button id="refineBtn" class="text-sm bg-esprit-red text-white px-3 py-2 rounded hover:bg-red-700" title="Affiner le résultat">Affiner</button>
          <button id="undoRefineBtn" class="text-sm text-gray-600 px-3 py-2 rounded hover:bg-gray-100 hidden">Annuler</button>
          <button id="copyResultBtn" class="text-sm text-gray-600 px-3 py-2 rounded hover:bg-gray-100">Copier</button>
          <button id="downloadResultBtn" class="text-sm text-gray-600 px-3 py-2 rounded hover:bg-gray-100">Télécharger</button>
          <button onclick="closeResultModal()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div id="resultModalBody" class="prose max-w-none text-gray-800 overflow-y-auto" style="max-height:60vh"></div>
    </div>
  </div>
</div>

<!-- Study Path Modal -->
<div id="studyPathModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
  <div class="flex items-start justify-center min-h-screen p-6">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full p-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-xl font-bold text-gray-900">Mon Parcours d'étude</h3>
          <div id="studyPathMeta" class="text-sm text-gray-600">Vos sujets et progrès personnalisés</div>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="regenerateStudyPath()" class="text-sm bg-indigo-600 text-white px-3 py-2 rounded hover:bg-indigo-700">Régénérer</button>
          <button onclick="trainStudyModel()" class="text-sm bg-yellow-500 text-white px-3 py-2 rounded hover:bg-yellow-600">Entrainer</button>
          <button onclick="getRecommendations()" class="text-sm bg-green-600 text-white px-3 py-2 rounded hover:bg-green-700">Recommander</button>
          <button onclick="closeStudyPath()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>
      <div class="flex gap-4">
  <div id="studyPathList" class="flex-1 space-y-3 overflow-y-auto" style="max-height:60vh"></div>
  <div id="studyRecommendations" class="w-full mt-3 text-sm text-gray-700"></div>
        <div class="w-80">
          <div class="mb-3">
            <label class="block text-sm text-gray-600">Poser une question dans le contexte du parcours</label>
            <input id="studyQuestion" type="text" class="w-full px-3 py-2 border border-gray-200 rounded mt-1" placeholder="Ex: Expliquer le concept X..." />
            <div class="flex gap-2 mt-2">
              <button onclick="askPathQuestion()" class="flex-1 bg-esprit-red text-white px-3 py-2 rounded">Poser</button>
              <button onclick="analyzeUserDocuments()" class="flex-1 bg-gray-100 text-gray-700 px-3 py-2 rounded">Analyser mes docs</button>
            </div>
          </div>
          <div id="studyPathAnswer" class="text-sm text-gray-700 bg-gray-50 p-3 rounded" style="min-height:120px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="readerMeta" data-docid="{{ document.id }}" data-session="{{ session_id }}" data-processed="{{ document.is_processed|yesno:'true,false' }}" style="display:none"></div>

<script>
const __readerMeta = document.getElementById('readerMeta');
const sessionId = __readerMeta ? __readerMeta.dataset.session : null;
const documentId = __readerMeta ? __readerMeta.dataset.docid : null;
const __documentIsProcessed = __readerMeta ? (__readerMeta.dataset.processed === 'true') : false;
let isLoading = false;

// Load chat history
loadChatHistory();

// Chat form submission
document.getElementById('chatForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  await sendMessage();
});

async function sendMessage() {
  const input = document.getElementById('messageInput');
  const message = input.value.trim();
  const submitButton = document.querySelector('#chatForm button[type="submit"]');

  if (!message || isLoading) return;
  
  // Add user message to chat
  addMessage('user', message);
  input.value = '';
  
  // Show loading indicator and mark loading state
  showLoadingIndicator();
  isLoading = true;
  if (submitButton) submitButton.disabled = true;

  try {
    // First: ask in French
    const frResponse = await fetch('/library/api/chat/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify({
        session_id: sessionId,
        message: `Réponds en français : ${message}`
      })
    }).then(r => r.json());

    if (frResponse && frResponse.response) {
      addMessage('assistant', `FR — ${frResponse.response}`);
    } else {
      addMessage('assistant', 'FR — Désolé, je n\'ai pas pu traiter votre demande.');
    }

    // Then: ask in English
    const enResponse = await fetch('/library/api/chat/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify({
        session_id: sessionId,
        message: `Please respond in English: ${message}`
      })
    }).then(r => r.json());

    if (enResponse && enResponse.response) {
      addMessage('assistant', `EN — ${enResponse.response}`);
    } else {
      addMessage('assistant', 'EN — Sorry, I could not process your request.');
    }
  } catch (error) {
    console.error('Error:', error);
    addMessage('assistant', 'Une erreur est survenue. Veuillez réessayer.');
  } finally {
    hideLoadingIndicator();
    isLoading = false;
    if (submitButton) submitButton.disabled = false;
  }
}

function addMessage(role, content) {
  const messagesContainer = document.getElementById('chatMessages');
  const messageDiv = document.createElement('div');
  
  if (role === 'user') {
    messageDiv.className = 'flex items-start gap-3 justify-end';
    messageDiv.innerHTML = `
      <div class="bg-gradient-to-r from-esprit-red to-red-600 text-white rounded-2xl rounded-tr-lg p-4 max-w-2xl">
        <p class="text-white">${escapeHtml(content)}</p>
      </div>
      <div class="p-2 bg-gray-200 rounded-lg">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
      </div>
    `;
  } else {
    messageDiv.className = 'flex items-start gap-3';
    messageDiv.innerHTML = `
      <div class="p-2 bg-gradient-to-r from-esprit-red to-red-600 rounded-lg">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
      </div>
      <div class="bg-gray-100 rounded-2xl rounded-tl-lg p-4 max-w-2xl">
        <p class="text-gray-800">${escapeHtml(content)}</p>
      </div>
    `;
  }
  
  messagesContainer.appendChild(messageDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function showLoadingIndicator() {
  const messagesContainer = document.getElementById('chatMessages');
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'loadingIndicator';
  loadingDiv.className = 'flex items-start gap-3';
  loadingDiv.innerHTML = `
    <div class="p-2 bg-gradient-to-r from-esprit-red to-red-600 rounded-lg">
      <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
      </svg>
    </div>
    <div class="bg-gray-100 rounded-2xl rounded-tl-lg p-4">
      <div class="flex items-center gap-2">
        <div class="flex space-x-1">
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
          <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        </div>
        <span class="text-gray-800">L'assistant réfléchit...</span>
      </div>
    </div>
  `;
  messagesContainer.appendChild(loadingDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideLoadingIndicator() {
  const loadingIndicator = document.getElementById('loadingIndicator');
  if (loadingIndicator) {
    loadingIndicator.remove();
  }
}

function loadChatHistory() {
  // Chat history is already loaded in the template
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Document Tools Functions
function showDocumentTools() {
  document.getElementById('documentToolsModal').classList.remove('hidden');
}

function closeDocumentTools() {
  document.getElementById('documentToolsModal').classList.add('hidden');
}

function generateSummary(event) {
  const button = (event && (event.currentTarget || event.target.closest('button'))) || document.querySelector('button[onclick*=generateSummary]');
  const originalText = button.innerHTML;
  button.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Génération...';
  button.disabled = true;

  // read UI options
  const length = document.getElementById('summaryLength') ? document.getElementById('summaryLength').value : 'medium';
  const autoRefine = document.getElementById('autoRefineSummary') ? document.getElementById('autoRefineSummary').checked : false;

  fetch(`/library/api/documents/${documentId}/summary/?length=${encodeURIComponent(length)}`)
    .then(response => response.json())
    .then(data => {
      if (data.summary) {
        // Populate result modal with a professional layout
        const titleEl = document.getElementById('resultModalTitle');
        const bodyEl = document.getElementById('resultModalBody');
        titleEl.textContent = 'Résumé Professionnel';
        // Simple paragraph splitting for readability
        const paragraphs = data.summary.split('\n\n');
        bodyEl.innerHTML = '';
        // Add a styled header and original summary
        const header = document.createElement('div');
        header.className = 'mb-4';
        const src = document.createElement('div');
        src.className = 'text-sm text-gray-500';
        src.textContent = `Source: ${document.title || documentId}`;
        header.appendChild(src);
        bodyEl.appendChild(header);

        const origContainer = document.createElement('div');
        origContainer.className = 'mb-4 bg-gray-50 p-4 rounded';
        paragraphs.forEach(p => {
          const pEl = document.createElement('p');
          pEl.className = 'text-gray-800';
          pEl.textContent = p.trim();
          origContainer.appendChild(pEl);
        });
        bodyEl.appendChild(origContainer);

        // Provide an actions section (copy/download)
        const actions = document.createElement('div');
        actions.className = 'flex gap-2 mb-4';
        const copyBtn = document.createElement('button');
        copyBtn.className = 'text-sm text-gray-600 px-3 py-2 rounded hover:bg-gray-100';
        copyBtn.textContent = 'Copier le résumé';
        copyBtn.onclick = () => copyText(data.summary);
        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'text-sm text-gray-600 px-3 py-2 rounded hover:bg-gray-100';
        downloadBtn.textContent = 'Télécharger';
        downloadBtn.onclick = () => downloadText(data.summary, `${documentId}_summary.txt`);
        actions.appendChild(copyBtn);
        actions.appendChild(downloadBtn);
        bodyEl.appendChild(actions);
        // Show modal
        document.getElementById('resultModal').classList.remove('hidden');
        // wire global copy/download buttons as fallback
        document.getElementById('copyResultBtn').onclick = () => copyText(data.summary);
        document.getElementById('downloadResultBtn').onclick = () => downloadText(data.summary, `${documentId}_summary.txt`);

        // Show modal (then optionally auto-refine)
        document.getElementById('resultModal').classList.remove('hidden');
        // store original for undo
        bodyEl.setAttribute('data-original', bodyEl.innerHTML);

        if (autoRefine) {
          // call refine flow which will replace modal body contents
          refineResult();
        }

        closeDocumentTools();
      } else {
        alert('Erreur lors de la génération du résumé');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Erreur lors de la génération du résumé');
    })
    .finally(() => {
      button.innerHTML = originalText;
      button.disabled = false;
    });
}

function generateQA(event) {
  const button = (event && (event.currentTarget || event.target.closest('button'))) || document.querySelector('button[onclick*=generateQA]');
  const originalText = button.innerHTML;
  button.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Génération...';
  button.disabled = true;
  // read requested number of QAs
  const num = document.getElementById('qaCount') ? parseInt(document.getElementById('qaCount').value || '5', 10) : 5;

  fetch(`/library/api/documents/${documentId}/qa-pairs/?num=${num}`)
    .then(response => response.json())
    .then(data => {
      if (data.qa_pairs) {
        // Keep the raw pairs in scope for grading
        window.__lastQaPairs = data.qa_pairs;

        const titleEl = document.getElementById('resultModalTitle');
        const bodyEl = document.getElementById('resultModalBody');
        titleEl.textContent = 'Questions (format quiz)';
        bodyEl.innerHTML = '';

        const form = document.createElement('form');
        form.id = 'qaForm';
        form.className = 'space-y-4';

        data.qa_pairs.forEach((qa, index) => {
          const item = document.createElement('div');
          item.className = 'p-4 border border-gray-100 rounded bg-white';
          item.setAttribute('data-qa-index', index);

          const q = document.createElement('h4');
          q.className = 'font-semibold flex items-center justify-between gap-2';
          const left = document.createElement('span');
          left.textContent = `${index + 1}. ${qa.question}`;
          const chips = document.createElement('span');
          chips.className = 'flex items-center gap-2 text-xs';
          if (qa.difficulty) {
            const chip = document.createElement('span');
            chip.className = 'px-2 py-0.5 rounded-full bg-gray-100 text-gray-700';
            chip.textContent = qa.difficulty;
            chips.appendChild(chip);
          }
          if (qa.reference) {
            const ref = document.createElement('span');
            ref.className = 'px-2 py-0.5 rounded-full bg-blue-50 text-blue-700';
            ref.textContent = qa.reference;
            chips.appendChild(ref);
          }
          q.appendChild(left);
          q.appendChild(chips);
          item.appendChild(q);

          const inputContainer = document.createElement('div');
          inputContainer.className = 'mt-2';

          // Render based on question type
          if (qa.type === 'mcq' && Array.isArray(qa.options) && qa.options.length) {
            // Shuffle options locally to avoid always showing answer first
            const opts = qa.options.slice();
            // small Fisher-Yates shuffle
            for (let i = opts.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [opts[i], opts[j]] = [opts[j], opts[i]];
            }
            opts.forEach((opt, oi) => {
              const id = `qa_${index}_opt_${oi}`;
              const label = document.createElement('label');
              label.className = 'flex items-center gap-3 mt-2';
              const input = document.createElement('input');
              input.type = 'radio';
              input.name = `qa_${index}`;
              input.value = opt;
              input.id = id;
              input.className = 'form-radio h-4 w-4 text-esprit-red';
              const span = document.createElement('span');
              span.className = 'text-sm text-gray-800';
              span.textContent = opt;
              label.appendChild(input);
              label.appendChild(span);
              inputContainer.appendChild(label);
            });
          } else if (qa.type === 'tf') {
            ['True', 'False'].forEach((opt, oi) => {
              const id = `qa_${index}_opt_tf_${oi}`;
              const label = document.createElement('label');
              label.className = 'flex items-center gap-3 mt-2';
              const input = document.createElement('input');
              input.type = 'radio';
              input.name = `qa_${index}`;
              input.value = opt;
              input.id = id;
              input.className = 'form-radio h-4 w-4 text-esprit-red';
              const span = document.createElement('span');
              span.className = 'text-sm text-gray-800';
              span.textContent = opt;
              label.appendChild(input);
              label.appendChild(span);
              inputContainer.appendChild(label);
            });
          } else {
            ['True', 'False'].forEach((opt, oi) => {
              const id = `qa_${index}_opt_tf_${oi}`;
              const label = document.createElement('label');
              label.className = 'flex items-center gap-3 mt-2';
              const input = document.createElement('input');
              input.type = 'radio';
              input.name = `qa_${index}`;
              input.value = opt;
              input.id = id;
              input.className = 'form-radio h-4 w-4 text-esprit-red';
              const span = document.createElement('span');
              span.className = 'text-sm text-gray-800';
              span.textContent = opt;
              label.appendChild(input);
              label.appendChild(span);
              inputContainer.appendChild(label);
            });
          }

          // Hidden field with canonical answer for client grading
          const ans = document.createElement('input');
          ans.type = 'hidden';
          ans.name = `qa_${index}_answer`;
          ans.value = qa.answer || '';
          item.appendChild(inputContainer);
          item.appendChild(ans);

          // small meta and actions
          const meta = document.createElement('div');
          meta.className = 'mt-3 flex items-center gap-2';
          const explainBtn = document.createElement('button');
          explainBtn.type = 'button';
          explainBtn.className = 'text-sm bg-esprit-red text-white px-3 py-1 rounded hover:bg-red-700';
          explainBtn.textContent = 'Développer';
          explainBtn.onclick = () => explainQA(qa.question, item);
          const copyBtn = document.createElement('button');
          copyBtn.type = 'button';
          copyBtn.className = 'text-sm text-gray-600 px-3 py-1 rounded hover:bg-gray-100';
          copyBtn.textContent = 'Copier Q/A';
          copyBtn.onclick = () => copyText(`Q: ${qa.question}\nA: ${qa.answer}`);
          meta.appendChild(copyBtn);
          meta.appendChild(explainBtn);
          item.appendChild(meta);

          form.appendChild(item);
        });

        // Actions area
        const actions = document.createElement('div');
        actions.className = 'mt-4 flex gap-2 items-center';
        const submitBtn = document.createElement('button');
        submitBtn.type = 'button';
        submitBtn.className = 'bg-esprit-red text-white px-4 py-2 rounded';
        submitBtn.textContent = 'Soumettre les réponses';
        submitBtn.onclick = () => gradeQuiz();

        const saveBtn = document.createElement('button');
        saveBtn.type = 'button';
        saveBtn.id = 'saveQuizBtn';
        saveBtn.className = 'bg-green-600 text-white px-4 py-2 rounded hidden';
        saveBtn.textContent = 'Enregistrer le résultat';
        saveBtn.onclick = () => submitQuiz();

        const resultSummary = document.createElement('div');
        resultSummary.id = 'quizResultSummary';
        resultSummary.className = 'text-sm text-gray-700 ml-3';

        actions.appendChild(submitBtn);
        actions.appendChild(saveBtn);
        actions.appendChild(resultSummary);

        form.appendChild(actions);
        bodyEl.appendChild(form);

        document.getElementById('resultModal').classList.remove('hidden');
        closeDocumentTools();
      } else {
        alert('Erreur lors de la génération des Q&A');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Erreur lors de la génération des Q&A');
    })
    .finally(() => {
      button.innerHTML = originalText;
      button.disabled = false;
    });

  // Grade the rendered quiz client-side
  function gradeQuiz() {
    const pairs = window.__lastQaPairs || [];
    if (!pairs.length) return alert('Aucune question à noter');

    let correct = 0;
    const results = [];
    

    pairs.forEach((qa, idx) => {
      const name = `qa_${idx}`;
      const inputs = document.getElementsByName(name);
      let selected = null;
      if (inputs && inputs.length) {
        for (let i = 0; i < inputs.length; i++) {
          if (inputs[i].checked) { selected = inputs[i].value; break; }
        }
      }

      const canonical = (document.querySelector(`input[name='${name}_answer']`) || {}).value || '';
      const isCorrect = compareAnswers(selected, canonical, qa.type);
      if (isCorrect) correct += 1;

      // mark UI
      const item = document.querySelector(`div[data-qa-index='${idx}']`);
      if (item) {
        // remove previous markers
        item.classList.remove('border-green-200');
        item.classList.remove('border-red-200');
        if (isCorrect) {
          item.classList.add('border-green-200');
          item.style.boxShadow = '0 0 0 2px rgba(34,197,94,0.06)';
        } else {
          item.classList.add('border-red-200');
          item.style.boxShadow = '0 0 0 2px rgba(239,68,68,0.06)';
        }
        // reveal correct answer
        let existing = item.querySelector('.qa-correct-answer');
        if (existing) existing.remove();
        const ansDiv = document.createElement('div');
        ansDiv.className = 'qa-correct-answer mt-2 text-sm';
        ansDiv.innerHTML = `<strong>Réponse attendue:</strong> <span class='text-gray-800'>${escapeHtml(canonical)}</span>`;
        item.appendChild(ansDiv);
      }

      results.push({ question: qa.question, selected: selected, correct: canonical, type: qa.type, correct_flag: !!isCorrect });
    });

    const total = pairs.length;
    const score = correct;
    const summaryEl = document.getElementById('quizResultSummary');
    if (summaryEl) summaryEl.innerHTML = `<strong>Score:</strong> ${score}/${total}`;

    // show save button
    const saveBtn = document.getElementById('saveQuizBtn');
    if (saveBtn) {
      saveBtn.classList.remove('hidden');
      // attach results to button dataset for later submission
      saveBtn.dataset.results = JSON.stringify(results);
      saveBtn.dataset.score = score;
      saveBtn.dataset.total = total;
    }
  }

  function compareAnswers(selected, canonical, qtype) {
    if (!selected || !canonical) return false;
    try {
      const s = String(selected).trim().toLowerCase();
      const c = String(canonical).trim().toLowerCase();
      if (qtype === 'mcq' || qtype === 'tf') {
        return s === c;
      }
      // short answer: consider correct if canonical is substring of selected or vice versa
      return s === c || s.includes(c) || c.includes(s);
    } catch (e) { return false; }
  }

  async function submitQuiz() {
    const saveBtn = document.getElementById('saveQuizBtn');
    if (!saveBtn) return alert('Bouton d\'enregistrement introuvable');
    const results = saveBtn.dataset.results ? JSON.parse(saveBtn.dataset.results) : [];
    const score = saveBtn.dataset.score ? Number(saveBtn.dataset.score) : null;
    const total = saveBtn.dataset.total ? Number(saveBtn.dataset.total) : null;

    try {
      const body = { score: score, total: total, results: results, metadata: { source: 'document_qa' } };
      const res = await fetch(`/library/api/documents/${documentId}/submit-quiz/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.status === 'ok') {
        alert('Résultat sauvegardé');
        saveBtn.classList.add('hidden');
      } else {
        alert('Réponse reçue (non persistée)');
      }
    } catch (err) {
      console.error('submitQuiz error', err);
      alert('Erreur lors de l\'enregistrement');
    }
  }
}

// Explain a QA item using chat endpoint and append a short expansion
async function explainQA(question, containerEl) {
  try {
    const loader = document.createElement('span');
    loader.className = 'ml-2 text-sm text-gray-500';
    loader.textContent = '…';
    containerEl.appendChild(loader);

    const prompt = `Explique et illustre la réponse à la question suivante de façon claire pour un étudiant : ${question}`;
    const res = await fetch('/library/api/chat/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify({ session_id: sessionId, message: prompt })
    });
    const data = await res.json();
    if (data && data.response) {
      const expl = document.createElement('div');
      expl.className = 'mt-2 text-sm text-gray-700 bg-gray-50 p-3 rounded';
      expl.textContent = data.response;
      containerEl.appendChild(expl);
    } else {
      alert('Impossible de développer la réponse pour le moment.');
    }
    loader.remove();
  } catch (err) {
    console.error('Explain error', err);
    alert('Erreur lors de la génération de l\'explication');
  }
}

function closeResultModal() {
  document.getElementById('resultModal').classList.add('hidden');
  document.getElementById('resultModalBody').innerHTML = '';
}

function copyText(text) {
  if (!navigator.clipboard) {
    // fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    alert('Copié dans le presse-papiers');
    return;
  }
  navigator.clipboard.writeText(text).then(() => {
    alert('Copié dans le presse-papiers');
  }).catch(() => {
    alert('Impossible de copier');
  });
}

function downloadText(text, filename) {
  const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Refine result using the chat endpoint (FR) — keeps original and allows undo
document.getElementById('refineBtn').addEventListener('click', function() {
  refineResult();
});
document.getElementById('undoRefineBtn').addEventListener('click', function() {
  const body = document.getElementById('resultModalBody');
  const original = body.getAttribute('data-original');
  if (original) {
    body.innerHTML = original;
    body.removeAttribute('data-original');
  }
  document.getElementById('undoRefineBtn').classList.add('hidden');
});

async function refineResult() {
  const tone = document.getElementById('refineTone').value || 'professional';
  const bodyEl = document.getElementById('resultModalBody');
  const originalText = bodyEl.innerText || bodyEl.textContent || '';
  if (!originalText.trim()) return alert('Aucun contenu à affiner');

  // Save original for undo
  if (!bodyEl.getAttribute('data-original')) {
    bodyEl.setAttribute('data-original', bodyEl.innerHTML);
  }

  // Show loading
  const refineBtn = document.getElementById('refineBtn');
  const undoBtn = document.getElementById('undoRefineBtn');
  refineBtn.disabled = true;
  refineBtn.textContent = 'Affinage...';

  // Prepare prompt in French to refine and structure the content for students
  const prompt = `Reformule et améliore le texte suivant pour des étudiants universitaires : rends-le professionnel, clair et actionnable. Fournis : 1) un titre concis, 2) 4-6 points clés (takeaways), 3) suggestions concrètes d'étude/next steps, 4) un court paragraphe explicatif. Ne change pas le sens. Ton: ${tone.toUpperCase()}\n\n---\n${originalText}`;

  try {
    const res = await fetch('/library/api/chat/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      body: JSON.stringify({ session_id: sessionId, message: prompt })
    });
    const data = await res.json();
    if (data && data.response) {
      // Replace modal body with refined output and enable undo
      bodyEl.innerText = data.response;
      document.getElementById('resultModalTitle').textContent += ' — Affiné';
      undoBtn.classList.remove('hidden');
      // update meta
      document.getElementById('resultMeta').textContent = `Affiné (${tone})`;
      // wire copy/download to refined text
      document.getElementById('copyResultBtn').onclick = () => copyText(data.response);
      document.getElementById('downloadResultBtn').onclick = () => downloadText(data.response, `${documentId}_refined.txt`);
    } else {
      alert('Impossible d\'affiner le texte pour le moment.');
    }
  } catch (err) {
    console.error('Refine error', err);
    alert('Erreur lors de l\'affinage');
  } finally {
    refineBtn.disabled = false;
    refineBtn.textContent = 'Affiner';
  }
}

function analyzeDocument() {
  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analyse...';
  button.disabled = true;
  
  fetch(`/library/api/documents/${documentId}/analysis/`)
    .then(response => response.json())
    .then(data => {
      if (data.analysis) {
        const analysis = data.analysis;
        let analysisText = `Analyse du document (vue d'ensemble):\n\n`;
        analysisText += `• Mots: ${analysis.word_count}\n`;
        analysisText += `• Paragraphes: ${analysis.paragraph_count}\n`;
        analysisText += `• Phrases: ${analysis.sentence_count}\n`;
        analysisText += `• Temps de lecture: ${analysis.reading_time_minutes} minutes\n`;
        analysisText += `• Score de complexité: ${analysis.complexity_score}/100\n`;
        if (analysis.unique_word_ratio_percent !== undefined) analysisText += `• Richesse lexicale: ${analysis.unique_word_ratio_percent}%\n`;
        if (analysis.avg_sentence_length !== undefined) analysisText += `• Longueur moyenne des phrases: ${analysis.avg_sentence_length} mots\n`;
        if (analysis.readability_grade_fk !== undefined) analysisText += `• Niveau de lecture (FK): ${analysis.readability_grade_fk}\n`;
        if (analysis.figures_count !== undefined || analysis.tables_count !== undefined) analysisText += `• Figures/Tables: ${analysis.figures_count||0}/${analysis.tables_count||0}\n`;
        if (analysis.references_markers !== undefined) analysisText += `• Références citées (repères): ${analysis.references_markers}\n\n`;
        analysisText += `Mots-clés principaux: ${analysis.top_keywords.join(', ')}\n\n`;
        if (analysis.potential_headings && analysis.potential_headings.length > 0) {
          analysisText += `Sections détectées:\n${analysis.potential_headings.map(h => `• ${h}`).join('\n')}`;
        }
        addMessage('assistant', analysisText);
        closeDocumentTools();
      } else {
        alert('Erreur lors de l\'analyse du document');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Erreur lors de l\'analyse du document');
    })
    .finally(() => {
      button.innerHTML = originalText;
      button.disabled = false;
    });
}

function exportDocument() {
  const formats = ['txt', 'md', 'json'];
  const format = prompt('Choisissez le format d\'export:\n1. TXT\n2. Markdown\n3. JSON\n\nEntrez le numéro (1-3):');
  
  if (format && ['1', '2', '3'].includes(format)) {
    const formatMap = { '1': 'txt', '2': 'md', '3': 'json' };
    window.open(`/library/api/documents/${documentId}/export/?format=${formatMap[format]}`, '_blank');
    closeDocumentTools();
  }
}

function clearInput() {
  document.getElementById('messageInput').value = '';
}

function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}

// Study Path UI/Actions
function showStudyPath() {
  document.getElementById('studyPathModal').classList.remove('hidden');
  fetchStudyPath();
}

function closeStudyPath() {
  document.getElementById('studyPathModal').classList.add('hidden');
  document.getElementById('studyPathAnswer').innerHTML = '';
}

async function fetchStudyPath() {
  try {
    const res = await fetch('/library/api/study-path/');
    const data = await res.json();
    if (data.status === 'ok') {
      renderStudyPath(data.profile || {}, data.study_path || []);
    } else {
      document.getElementById('studyPathList').innerHTML = '<div class="text-sm text-red-600">Impossible de récupérer le parcours.</div>';
    }
  } catch (err) {
    console.error('fetchStudyPath error', err);
    document.getElementById('studyPathList').innerHTML = '<div class="text-sm text-red-600">Erreur de connexion.</div>';
  }
}

function renderStudyPath(profile, path) {
  const container = document.getElementById('studyPathList');
  container.innerHTML = '';
  // Show career suggestions if available
  const recBox = document.getElementById('studyRecommendations');
  if (profile && profile.career_suggestions && Array.isArray(profile.career_suggestions)) {
    recBox.innerHTML = '<h4 class="font-semibold mb-2">Suggestions de carrière</h4>' + profile.career_suggestions.map(r => `
      <div class="flex items-center justify-between bg-indigo-50 p-2 rounded mb-1">
        <div class="text-sm">${escapeHtml(r.career)}</div>
        <div class="text-xs text-gray-500">Score: ${r.score}</div>
      </div>
    `).join('');
  }

  if (!path || path.length === 0) {
    container.innerHTML = '<div class="text-sm text-gray-600">Aucun sujet trouvé pour le moment. Cliquez sur Régénérer ou Analyse.</div>';
    return;
  }

  path.forEach((topic, idx) => {
    const card = document.createElement('div');
    card.className = 'p-4 border border-gray-100 rounded bg-white';

    const title = document.createElement('div');
    title.className = 'font-semibold';
    title.textContent = `${idx+1}. ${topic.title || topic.name || 'Sujet'}`;

    const meta = document.createElement('div');
    meta.className = 'text-sm text-gray-500 mt-1';
    meta.textContent = `Difficulté: ${topic.difficulty || 'moyenne'} — Maîtrise: ${((topic.mastery||0)*100).toFixed(0)}%`;

    const snippet = document.createElement('div');
    snippet.className = 'text-sm text-gray-700 mt-2';
    snippet.textContent = (topic.snippets && topic.snippets.length>0) ? topic.snippets[0].slice(0,240) + (topic.snippets[0].length>240? '…':'') : (topic.summary || 'Aucun extrait disponible');

    const actions = document.createElement('div');
    actions.className = 'mt-3 flex gap-2';
    const doneBtn = document.createElement('button');
    doneBtn.className = 'px-3 py-1 text-sm bg-green-500 text-white rounded';
    doneBtn.textContent = 'Marquer comme fait';
    doneBtn.onclick = () => updateProgress(topic.id || topic.topic_id || topic.topicId, 1.0, 'completed');

    const askBtn = document.createElement('button');
    askBtn.className = 'px-3 py-1 text-sm bg-esprit-red text-white rounded';
    askBtn.textContent = 'Poser une question';
    askBtn.onclick = () => {
      const q = prompt('Votre question pour ce sujet:');
      if (q && q.trim()) {
        askQuestionInContext(q, topic);
      }
    };

    actions.appendChild(doneBtn);
    actions.appendChild(askBtn);

    card.appendChild(title);
    card.appendChild(meta);
    card.appendChild(snippet);
    card.appendChild(actions);

    container.appendChild(card);
  });
}

async function updateProgress(topicId, mastery, status) {
  try {
    const body = { topic_id: topicId, mastery_score: mastery, status: status };
    const res = await fetch('/library/api/study-path/update/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if (data.status === 'ok') {
      fetchStudyPath();
    } else {
      alert('Erreur lors de la mise à jour du progrès');
    }
  } catch (err) {
    console.error('updateProgress error', err);
    alert('Erreur réseau lors de la mise à jour');
  }
}

async function askQuestionInContext(question, topic) {
  try {
    const prompt = `${question}\n
Contexte: ${topic.title || topic.name}. Utilise les extraits disponibles et réponds de façon claire pour un étudiant.`;
    const res = await fetch('/library/api/study-path/answer/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ question: prompt })
    });
    const data = await res.json();
    if (data.status === 'ok') {
      alert('Réponse: ' + (data.answer || 'Pas de réponse'));
    } else {
      alert('Impossible de répondre pour le moment.');
    }
  } catch (err) {
    console.error('askQuestionInContext error', err);
    alert('Erreur lors de la question');
  }
}

async function regenerateStudyPath() {
  try {
    const listEl = document.getElementById('studyPathList');
    listEl.innerHTML = '<div class="text-sm text-gray-500">Génération en cours… (cela peut prendre quelques secondes)</div>';
    const res = await fetch('/library/api/study-path/analyze/', { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value } });
    const data = await res.json();
    if (data.status === 'ok') {
      // Show diagnostics so the student sees what was scanned
      const diag = document.createElement('div');
      diag.className = 'text-sm text-gray-600 my-2';
      diag.innerHTML = `Documents scannés: ${data.documents_scanned} — Traités: ${data.documents_processed} — Sujets trouvés: ${data.topics_found}`;
      listEl.prepend(diag);

      if (data.topics_preview && data.topics_preview.length > 0) {
        // append small preview
        const preview = document.createElement('div');
        preview.className = 'mt-2 space-y-2';
        data.topics_preview.forEach((t) => {
          const p = document.createElement('div');
          p.className = 'text-sm text-gray-700 bg-gray-50 p-2 rounded';
          p.textContent = t.title || (t.snippets && t.snippets[0] ? t.snippets[0].text.slice(0,180) : 'Sujet');
          preview.appendChild(p);
        });
        listEl.appendChild(preview);
      }

      // Refresh the full study path list
      fetchStudyPath();
    } else {
      alert('Erreur lors de la génération.');
      fetchStudyPath();
    }
  } catch (err) {
    console.error('regenerateStudyPath error', err);
    alert('Erreur réseau lors de la génération.');
  }
}

async function askPathQuestion() {
  const q = document.getElementById('studyQuestion').value.trim();
  if (!q) return alert('Veuillez écrire une question');
  try {
    const res = await fetch('/library/api/study-path/answer/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: JSON.stringify({ question: q })
    });
    const data = await res.json();
    if (data.status === 'ok') {
      document.getElementById('studyPathAnswer').textContent = data.answer || 'Pas de réponse.';
    } else {
      document.getElementById('studyPathAnswer').textContent = 'Erreur: ' + (data.message || 'Impossible de répondre.');
    }
  } catch (err) {
    console.error('askPathQuestion error', err);
    document.getElementById('studyPathAnswer').textContent = 'Erreur réseau.';
  }
}

async function analyzeUserDocuments() {
  try {
    const res = await fetch('/library/api/study-path/analyze/', {
      method: 'POST',
      headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
    });
    const data = await res.json();
    if (data.status === 'ok') {
      alert(`Analyse terminée — sujets trouvés: ${data.topics_found || 0}`);
      fetchStudyPath();
    } else {
      alert('Erreur lors de l\'analyse');
    }
  } catch (err) {
    console.error('analyzeUserDocuments error', err);
    alert('Erreur réseau lors de l\'analyse');
  }
}

async function trainStudyModel() {
  try {
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]') ? document.querySelector('[name=csrfmiddlewaretoken]').value : '';
    const res = await fetch('/library/api/study-path/train/', {
      method: 'POST',
      headers: { 'X-CSRFToken': csrf, 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    const data = await res.json();
    if (data.status === 'ok') {
      alert('Entraînement terminé — accuracy: ' + (data.metrics?.accuracy ?? 'n/a'));
      // Refresh study path and recommendations
      fetchStudyPath();
      getRecommendations();
    } else {
      alert('Erreur entrainement: ' + (data.message || JSON.stringify(data)));
    }
  } catch (err) {
    console.error('trainStudyModel error', err);
    alert('Erreur réseau lors de l\'entraînement');
  }
}

async function getRecommendations() {
  try {
    const res = await fetch('/library/api/study-path/recommend/?k=6');
    const data = await res.json();
    const container = document.getElementById('studyRecommendations');
    if (!container) return;
    if (data.status !== 'ok') {
      container.innerHTML = '<div class="text-sm text-red-600">Impossible de charger les recommandations.</div>';
      return;
    }
    const recs = data.recommendations || [];
    if (!recs.length) {
      container.innerHTML = '<div class="text-sm text-gray-600">Aucune recommandation pour le moment.</div>';
      return;
    }
    container.innerHTML = '<h4 class="font-semibold mb-2">Recommandations</h4>' + recs.map(r => `
      <div class="flex items-center justify-between bg-gray-50 p-2 rounded mb-1">
        <div class="text-sm">${escapeHtml(r.title || r.topic_id)}</div>
        <div class="text-xs text-gray-500">Score: ${(Math.round((r.score||0)*100))/100}</div>
      </div>
    `).join('');
  } catch (err) {
    console.error('getRecommendations error', err);
  }
}

// Auto-refresh handled earlier via readerMeta values (no inline template tags here)
</script>
{% endblock %}