{% extends "base.html" %}
{% block content %}
<div class="max-w-4xl mx-auto py-8 px-4">
  <div class="bg-white rounded-2xl shadow border border-gray-200 p-6">
    <h1 class="text-2xl font-semibold mb-2">Candidature</h1>
    <p class="text-sm text-gray-600">{{ opportunity.role }} @ {{ opportunity.company }}</p>
    {% if app.interview %}
      <div class="mt-3 p-3 rounded border border-blue-200 bg-blue-50 text-sm text-blue-800">
        Entretien: {{ app.interview.date_time|date:"Y-m-d H:i" }} ({{ app.interview.duration|default:'30' }} min)
        {% if app.interview.meet_link %} — <a class="underline" href="{{ app.interview.meet_link }}" target="_blank">Lien Meet</a>{% endif %}
      </div>
    {% endif %}
    <div class="mt-4 grid md:grid-cols-2 gap-4">
      <div>
        <h3 class="font-semibold">Étudiant</h3>
        <p class="text-gray-700">{{ user.username }} {% if user.email %}<span class="text-gray-500">&lt;{{ user.email }}&gt;</span>{% endif %}</p>
        <p class="text-sm text-gray-500">Soumise le {{ app.created_at|date:"Y-m-d H:i" }}</p>
      </div>
      <div class="text-right">
        <span class="inline-block px-3 py-1 rounded-full border text-sm">{{ app.status|title }}</span>
      </div>
    </div>

    <div class="mt-4 space-y-2">
      {% if app.cv_url %}<p>CV: <a class="text-esprit-red underline" href="{{ app.cv_url }}" target="_blank">Ouvrir</a></p>{% endif %}
      {% if app.cover_url %}<p>Lettre (URL): <a class="text-esprit-red underline" href="{{ app.cover_url }}" target="_blank">Ouvrir</a></p>{% endif %}
      {% if app.cover_text %}
        <details class="mt-2">
          <summary class="cursor-pointer text-sm text-gray-700">Voir la lettre enregistrée</summary>
          <pre class="mt-2 whitespace-pre-wrap text-sm bg-gray-50 border rounded p-3">{{ app.cover_text }}</pre>
        </details>
      {% endif %}
    </div>

    <div class="mt-6 flex justify-end gap-2">
      {% if app.status != 'validated' %}
        <button
          hx-get="{% url 'careers:admin-application-interview' app.id %}"
          hx-target="#admin-modal-content" hx-swap="innerHTML"
          class="px-4 py-2 rounded bg-esprit-red text-white">Planifier un entretien</button>
        <button
          hx-get="{% url 'careers:admin-application-validate' app.id %}"
          hx-target="#admin-modal-content" hx-swap="innerHTML"
          class="px-4 py-2 rounded border">Valider pour stage</button>
      {% endif %}
    </div>
  </div>

  <div id="admin-modal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
      <div class="flex justify-between items-center px-4 py-2 border-b">
        <h3 class="font-semibold">Action</h3>
        <button type="button" class="text-gray-500 hover:text-gray-700" onclick="document.getElementById('admin-modal').classList.add('hidden')">✕</button>
      </div>
      <div id="admin-modal-content" class="p-4"></div>
    </div>
  </div>
  <script>
    document.addEventListener('htmx:afterSwap', function (event) {
      if (event.detail.target && event.detail.target.id === 'admin-modal-content') {
        document.getElementById('admin-modal').classList.remove('hidden');
      }
    });
    document.addEventListener('click', function (event) {
      const modal = document.getElementById('admin-modal');
      if (modal && !modal.classList.contains('hidden') && event.target === modal) {
        modal.classList.add('hidden');
      }
    });
  </script>
</div>
{% endblock %}
