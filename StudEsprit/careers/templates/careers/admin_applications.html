{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl mx-auto py-8 px-4">
  <div class="bg-white rounded-2xl shadow border border-gray-200 p-6 mb-6">
    <h1 class="text-2xl font-semibold">Candidatures (Admin)</h1>
    <form hx-get="{% url 'careers:admin-applications' %}" hx-target="#admin-apps" hx-swap="outerHTML" class="grid gap-3 md:grid-cols-4 mt-4">
      <div>
        <label class="text-sm text-gray-600">Statut</label>
        <select name="status" class="mt-1 w-full border rounded px-2 py-1">
          <option value="">— Tous —</option>
          <option value="submitted" {% if filters.status == 'submitted' %}selected{% endif %}>Soumise</option>
          <option value="interview" {% if filters.status == 'interview' %}selected{% endif %}>Entretien</option>
          <option value="validated" {% if filters.status == 'validated' %}selected{% endif %}>Validée</option>
          <option value="rejected" {% if filters.status == 'rejected' %}selected{% endif %}>Refusée</option>
        </select>
      </div>
      <div>
        <label class="text-sm text-gray-600">Opportunité</label>
        <select name="opportunity" class="mt-1 w-full border rounded px-2 py-1">
          <option value="">— Toutes —</option>
          {% for o in opportunities %}
            <option value="{{ o.id }}" {% if filters.opportunity == o.id|stringformat:'s' %}selected{% endif %}>{{ o.role }} @ {{ o.company }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="text-sm text-gray-600">Depuis le</label>
        <input name="date" type="date" value="{{ filters.date }}" class="mt-1 w-full border rounded px-2 py-1" />
      </div>
      <div class="flex items-end justify-end">
        <button type="submit" class="px-4 py-2 rounded-full bg-esprit-red text-white">Filtrer</button>
      </div>
    </form>
  </div>

  <div id="admin-apps" class="bg-white rounded-2xl shadow border border-gray-200">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Étudiant</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Opportunité</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Entretien</th>
            <th class="px-4 py-2"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          {% for r in rows %}
          <tr>
            <td class="px-4 py-2 text-sm">{{ r.student|default:'—' }}</td>
            <td class="px-4 py-2 text-sm">{{ r.opportunity }}</td>
            <td class="px-4 py-2 text-sm">{{ r.status|title }}</td>
            <td class="px-4 py-2 text-sm">
              {% if r.interview %}
                <div>
                  <div class="text-gray-700">{{ r.interview_dt|date:"Y-m-d H:i" }} ({{ r.interview_duration|default:'30' }} min)</div>
                  {% if r.interview_link %}
                    <a class="text-esprit-red underline" href="{{ r.interview_link }}" target="_blank">Lien Meet</a>
                  {% endif %}
                </div>
              {% else %}
                —
              {% endif %}
            </td>
            <td class="px-4 py-2 text-right whitespace-nowrap">
              <a href="{% url 'careers:admin-application-detail' r.id %}" class="px-3 py-1 rounded border text-sm">Détails</a>
              {% if r.status != 'validated' %}
                <button
                  hx-get="{% url 'careers:admin-application-interview' r.id %}"
                  hx-target="#admin-modal-content" hx-swap="innerHTML"
                  class="px-3 py-1 rounded bg-esprit-red text-white text-sm">Planifier</button>
                <button
                  hx-get="{% url 'careers:admin-application-validate' r.id %}"
                  hx-target="#admin-modal-content" hx-swap="innerHTML"
                  class="px-3 py-1 rounded border text-sm">Valider</button>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr><td class="px-4 py-6 text-center text-gray-600" colspan="5">Aucune candidature.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div id="admin-modal" class="fixed inset-0 bg-black/40 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
      <div class="flex justify-between items-center px-4 py-2 border-b">
        <h3 class="font-semibold">Action</h3>
        <button type="button" class="text-gray-500 hover:text-gray-700" onclick="document.getElementById('admin-modal').classList.add('hidden')">✕</button>
      </div>
      <div id="admin-modal-content" class="p-4"></div>
    </div>
  </div>

  <script>
    document.addEventListener('htmx:afterSwap', function (event) {
      if (event.detail.target && event.detail.target.id === 'admin-modal-content') {
        document.getElementById('admin-modal').classList.remove('hidden');
      }
    });
    document.body.addEventListener('applications-refresh', function(){
      window.location.reload();
    });
    document.addEventListener('click', function (event) {
      const modal = document.getElementById('admin-modal');
      if (modal && !modal.classList.contains('hidden') && event.target === modal) {
        modal.classList.add('hidden');
      }
    });
  </script>
</div>
{% endblock %}
