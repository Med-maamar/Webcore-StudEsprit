{% extends "base.html" %}
{% block content %}
<div class="max-w-5xl mx-auto py-8 px-4">
  <div class="bg-white rounded-2xl shadow border border-gray-200 p-6 mb-6">
    <h1 class="text-3xl font-semibold">Mes candidatures</h1>
    <p class="text-gray-600 mt-1">Liste de vos candidatures récentes. Page réservée aux étudiants.</p>
  </div>

  {% if items %}
    <div class="space-y-6">
      {% for item in items %}
        {% with app=item.app iv=item.iv %}
        <div class="bg-white rounded-2xl shadow border border-gray-200 p-6">
          <div class="grid md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <h2 class="text-xl font-semibold">{{ app.opportunity.role }} @ {{ app.opportunity.company }}</h2>
              <p class="text-sm text-gray-600">
                Statut:
                <span class="font-medium">{{ app.status|title }}</span>
                {% if app.status == 'validated' %}
                  <span class="inline-flex items-center text-green-700 bg-green-50 border border-green-200 rounded-full px-2 py-0.5 text-xs ml-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-7.25 7.25a1 1 0 01-1.414 0l-3-3a1 1 0 011.414-1.414L8.5 11.586l6.543-6.543a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Acceptée
                  </span>
                {% endif %}
              </p>
              {% if app.cv_url %}
                <p class="text-sm mt-1">CV: <a href="{{ app.cv_url }}" target="_blank" class="text-esprit-red underline">Ouvrir</a></p>
              {% endif %}
              {% if app.cover_url %}
                <p class="text-sm">Lettre (URL): <a href="{{ app.cover_url }}" target="_blank" class="text-esprit-red underline">Ouvrir</a></p>
              {% endif %}
              {% if app.cover_text %}
                <details class="mt-2">
                  <summary class="text-sm text-gray-700 cursor-pointer">Voir la lettre enregistrée</summary>
                  <pre class="mt-2 whitespace-pre-wrap text-sm bg-gray-50 border rounded p-3">{{ app.cover_text }}</pre>
                </details>
              {% endif %}
            </div>
            <div class="text-sm text-gray-500 md:text-right">Candidaté le {{ app.created_at|date:"Y-m-d H:i" }}</div>
          </div>

          <div class="mt-6">
            <div class="max-w-5xl mx-auto">
              {% if iv %}
                <div class="mb-4 p-3 rounded border border-blue-200 bg-blue-50 text-sm text-blue-800">
                  Entretien prévu le <strong>{{ iv.date_time|date:"Y-m-d H:i" }}</strong>
                  ({{ iv.duration|default:'30' }} min)
                  {% if iv.meet_link %}
                    — <a class="underline" href="{{ iv.meet_link }}" target="_blank">Lien Meet</a>
                  {% endif %}
                </div>
              {% endif %}
              <h3 class="text-lg font-semibold mb-2">Préparation d'entretien</h3>
              {% if not app.interview_prep %}
                <form
                  hx-post="{% url 'careers:application-interview-prep' app.id %}"
                  hx-target="#prep-{{ app.id }}"
                  hx-swap="innerHTML"
                  class="flex justify-center"
                >
                  {% csrf_token %}
                  <button type="submit" class="px-5 py-2 rounded-full bg-esprit-red text-white hover:bg-[#a00d26]">Générer des questions difficiles</button>
                </form>
              {% endif %}
              <div id="prep-{{ app.id }}" class="mt-3">
                {% if app.interview_prep %}
                  {% include 'careers/partials/interview_prep_result.html' with result=app.interview_prep app_id=app.id %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center text-gray-600">Vous n'avez pas encore de candidatures.</div>
  {% endif %}
</div>
{% endblock %}
<script>
  // Rafraîchir automatiquement la page quand une action API le demande
  document.body.addEventListener('applications-refresh', function(){
    window.location.reload();
  });
  // Optionnel: activer htmx boost pour les liens internes
  document.body.setAttribute('hx-boost', 'true');
  document.body.setAttribute('hx-target', 'main');
  document.body.setAttribute('hx-swap', 'innerHTML');
</script>
