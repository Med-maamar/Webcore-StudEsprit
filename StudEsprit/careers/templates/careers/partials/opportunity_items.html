<div id="opportunity-results" class="mt-6 grid gap-4">
  {% if opportunities %}
    {% for opportunity in opportunities %}
      <div class="border border-gray-200 bg-white rounded-2xl shadow-sm p-6">
        <div class="flex justify-between items-start">
          <div>
            <h2 class="text-xl font-semibold">{{ opportunity.role }} @ {{ opportunity.company }}</h2>
            <p class="text-sm text-gray-600">{{ opportunity.location|default:"Location flexible" }}</p>
          </div>
          <p class="text-sm text-gray-500">Date limite: {{ opportunity.deadline|date:"Y-m-d H:i" }}</p>
        </div>
        <p class="mt-3 text-gray-700">{{ opportunity.description|default:"No description provided" }}</p>
        <div class="mt-3 flex flex-wrap gap-2">
          {% for skill in opportunity.skills %}
            <span class="px-2 py-1 text-xs bg-red-50 text-esprit-red rounded-full border border-red-200">{{ skill }}</span>
          {% empty %}
            <span class="text-sm text-gray-500">No skills listed</span>
          {% endfor %}
        </div>
        <div class="mt-4 flex flex-wrap gap-3">
          <a
            href="{% url 'careers:opportunity-detail' opportunity.id %}"
            class="px-3 py-2 rounded-full border border-gray-300 text-gray-700 hover:bg-gray-50"
          >
            Détails
          </a>
          {% if current_user and current_user.is_authenticated and current_user.role|lower != 'admin' %}
            <button
              hx-get="{% url 'careers:opportunity-apply' opportunity.id %}"
              hx-target="#apply-modal-content"
              hx-swap="innerHTML"
              class="px-3 py-2 rounded-full bg-esprit-red text-white hover:bg-[#a00d26]"
              type="button"
            >
              Postuler
            </button>
          {% else %}
            <button
              hx-get="{% url 'careers:opportunity-edit' opportunity.id %}"
              hx-target="#opportunity-admin-modal-content"
              hx-swap="innerHTML"
              class="px-3 py-2 rounded-full border border-gray-300 hover:bg-gray-50"
              type="button"
            >
              Modifier
            </button>
            <button
              hx-get="{% url 'careers:opportunity-delete' opportunity.id %}"
              hx-target="#opportunity-admin-modal-content"
              hx-swap="innerHTML"
              class="px-3 py-2 rounded-full bg-red-600 text-white hover:bg-red-700"
              type="button"
            >
              Supprimer
            </button>
          {% endif %}
          <a
            href="{{ opportunity.apply_url }}"
            target="_blank"
            rel="noopener"
            class="px-3 py-2 rounded text-esprit-red underline"
          >
            Lien externe
          </a>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="text-center text-gray-500 border rounded-lg py-10">No opportunities match your filters.</div>
  {% endif %}

  <div id="apply-modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-xl">
      <div class="flex justify-between items-center px-4 py-2 border-b">
        <h3 class="font-semibold">Apply for opportunity</h3>
        <button
          type="button"
          class="text-gray-500 hover:text-gray-700"
          onclick="document.getElementById('apply-modal').classList.add('hidden')"
        >
          ✕
        </button>
      </div>
      <div id="apply-modal-content" class="p-4"></div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('htmx:afterSwap', function (event) {
    if (event.detail.target && event.detail.target.id === 'apply-modal-content') {
      document.getElementById('apply-modal').classList.remove('hidden');
    }
  });
  document.addEventListener('click', function (event) {
    const modal = document.getElementById('apply-modal');
    if (modal && !modal.classList.contains('hidden') && event.target === modal) {
      modal.classList.add('hidden');
    }
  });
</script>
