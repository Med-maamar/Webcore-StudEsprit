{% if error %}
  <div class="p-4 bg-red-50 border border-red-200 rounded">{{ error }}</div>
{% else %}
  <div x-data="quizComponent()" class="space-y-4">
    <div class="bg-blue-50 border border-blue-100 p-3 rounded-lg flex items-center justify-between">
      <div class="flex items-center gap-3">
        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-3-3v6m9 1a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <div>
          <div class="text-sm font-semibold">Quiz G√©n√©r√©</div>
          <div class="text-xs text-gray-600">{{ questions|length }} questions g√©n√©r√©es automatiquement √† partir du PDF</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button @click="showAnswers = !showAnswers" class="px-3 py-1 rounded border text-sm">Afficher les r√©ponses correctes</button>
      </div>
    </div>

    <template x-for="(q, idx) in questions" :key="idx">
      <div class="border rounded-lg p-4" :class="{'border-red-300 bg-red-50': showAnswers && (userAnswers[idx] !== undefined && userAnswers[idx] !== q.correct_answer)}">
        <div class="flex gap-3 items-start">
          <div class="flex-shrink-0">
            <div class="h-8 w-8 rounded-full bg-esprit-red text-white flex items-center justify-center font-semibold"> <span x-text="idx+1"></span></div>
          </div>
          <div class="flex-1">
            <div class="font-semibold text-sm" x-text="q.question"></div>
            <div class="mt-3 space-y-2">
              <template x-for="letter in Object.keys(q.options)" :key="letter">
                <label class="flex items-center gap-3 p-2 border rounded-lg hover:shadow-sm cursor-pointer"
                       :class="showAnswers ? (letter == q.correct_answer ? 'border-green-300 bg-green-50' : (userAnswers[idx] == letter ? 'border-red-300 bg-red-50' : 'border-gray-100')) : 'border-gray-100'">
                  <input type="radio" :name="'q' + idx" :value="letter" x-model="userAnswers[idx]" class="form-radio" />
                  <div class="flex items-center gap-3">
                    <div class="text-esprit-red font-semibold"> <span x-text="letter"></span>.</div>
                    <div x-text="q.options[letter]"></div>
                  </div>
                </label>
              </template>
            </div>
            <div class="mt-2 text-xs text-gray-500" x-show="showAnswers" x-text="'Source: ' + (q.source || '')"></div>
          </div>
        </div>
      </div>
    </template>

    <div class="flex items-center gap-3">
      <button @click="checkAnswers()" class="px-4 py-2 rounded bg-esprit-red text-white">Corriger le quiz</button>
      <div x-show="checked" class="text-sm">Score: <span x-text="score"></span> / <span x-text="questions.length"></span></div>
      <button @click="reset()" class="px-3 py-1 rounded border ml-auto" x-show="checked">Recommencer</button>
    </div>

  </div>

  <script>
    function quizComponent(){
      const questions = JSON.parse('{{ questions_json|escapejs }}');
      return {
        questions: questions,
        userAnswers: {},
        showAnswers: false,
        checked: false,
        score: 0,
        checkAnswers(){
          this.score = 0;
          for(let i=0;i<this.questions.length;i++){
            const q = this.questions[i];
            const ans = this.userAnswers[i] || '';
            if(ans === q.correct_answer) this.score += 1;
          }
          this.showAnswers = true;
          this.checked = true;
        },
        reset(){
          this.userAnswers = {};
          this.showAnswers = false;
          this.checked = false;
          this.score = 0;
        }
      }
    }
  </script>
{% endif %}
{% comment %} Inline version of the tests view (without modal wrapper). {% endcomment %}
<div class="space-y-6">
  {% if error %}
    <div class="p-4 bg-red-50 border border-red-200 text-red-800 rounded-lg">{{ error }}</div>
  {% else %}
    {% if questions %}
      <div class="mb-4 p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded-lg text-sm">
        <strong>üìä {{ questions|length }} question{{ questions|length|pluralize }}</strong>
      </div>
      <div class="space-y-6">
        {% for q in questions %}
          <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <div class="flex items-start gap-3 mb-3">
              <div class="flex-shrink-0 w-8 h-8 bg-esprit-red text-white rounded-full flex items-center justify-center font-bold">{{ forloop.counter }}</div>
              <div class="flex-1">
                <p class="text-base font-medium text-esprit-dark leading-relaxed">{{ q.question }}</p>
              </div>
            </div>
            <div class="ml-11 space-y-2">
              {% for letter, option in q.options.items %}
                <div class="p-3 rounded-lg border-gray-200">
                  <span class="font-semibold text-esprit-red">{{ letter }}.</span>
                  <span class="ml-2 text-gray-700">{{ option }}</span>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="p-4 bg-yellow-50 border border-yellow-200 text-yellow-800 rounded-lg">Aucune question disponible.</div>
    {% endif %}
  {% endif %}

  <div class="pt-4 border-t flex justify-between">
    <button hx-get="{% url 'cour_pdf_partial' cid %}" hx-target="#cour-content" hx-swap="innerHTML" class="px-4 py-2 border rounded">Retour au PDF</button>
    <a href="{% url 'program_public_cour_detail' cid %}" class="px-4 py-2 border rounded">Ouvrir la page du cours</a>
  </div>
</div>
